#!/bin/sh

# Updates the current wm theme and makes it persistent
# Available values are located in $HOME/.config/xresources/colors
# Run with `--prompt` to execute a dmenu-style prompt to choose a colorscheme

case "$1" in
  "--prompt" | "-p" | "")
    colors=$(ls -ct "$HOME/.config/xresources/colors")
    COLOR="$(echo "$colors" | rofi -dmenu -p "theme" -width 350 -lines 6)"
  ;;
  *)
    COLOR="$1"
  ;;
esac

if [ -z "$COLOR" ]; then
    exit 0
fi

echo "$COLOR" > ~/.theme

~/.config/herbstluftwm/save-layout
herbstclient reload
sleep 2

# Update colorscheme timestamp (used to sort in switcher)
touch "$HOME/.config/xresources/colors/$COLOR"

~/.config/herbstluftwm/load-layout

# Reload the terminal color palette
background="$(xrdb -query | awk '/^*.?background:/{print $2}')" 
color0="$(xrdb -query | awk '/^*.?color0:/{print $2}')"

# works when background is equal to color0 due to inner padding
if [ "$background" = "$color0" ]; then
    killall urxvt -SIGHUP
    sleep .5
    killall urxvt -SIGHUP
else
    notify-send "switch-colors" "\nfailed to set urxvt palette"
fi

# Notify completion
notify-send "switch-colors" "\n$COLOR"
